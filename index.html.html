<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>AirDraw - Hand Tracking Drawing</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json,{%22name%22:%22AirDraw%22,%22short_name%22:%22AirDraw%22,%22description%22:%22Hand%20tracking%20drawing%20app%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23000000%22,%22theme_color%22:%22%23ffffff%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20100%20100'%3E%3Ctext%20y='.9em'%20font-size='90'%3Eâœ‹%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Prevent zoom on input focus (iOS Safari) */
        input, select, textarea {
            font-size: 16px !important;
        }
        
        /* Hide address bar on mobile */
        body {
            margin: 0;
            padding: 0;
            overscroll-behavior: none;
        }
        
        /* Improve touch targets */
        button, input[type="range"], input[type="color"] {
            min-height: 44px;
            touch-action: manipulation;
        }
        
        /* Video responsive */
        video {
            max-width: 100vw;
            max-height: 60vh;
            object-fit: cover;
        }
        
        canvas {
            max-width: 100vw;
            max-height: 60vh;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        function AirDraw() {
            const videoRef = useRef(null);
            const canvasRef = useRef(null);
            const drawingRef = useRef({ isDrawing: false, lastX: null, lastY: null });
            const handsRef = useRef(null);
            const animationRef = useRef(null);

            const [running, setRunning] = useState(false);
            const [brushColor, setBrushColor] = useState("#ff0000");
            const [brushSize, setBrushSize] = useState(8);
            const [pinchThreshold, setPinchThreshold] = useState(50);
            const [status, setStatus] = useState("ready");
            const [isMobile, setIsMobile] = useState(false);

            useEffect(() => {
                // Detect mobile device
                const checkMobile = () => {
                    const mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    setIsMobile(mobile);
                    
                    // Adjust defaults for mobile
                    if (mobile) {
                        setBrushSize(12);
                        setPinchThreshold(60);
                    }
                };
                checkMobile();
                
                // Hide address bar on mobile
                if (window.innerHeight < window.innerWidth) {
                    setTimeout(() => {
                        window.scrollTo(0, 1);
                    }, 100);
                }
            }, []);

            function drawLine(ctx, x1, y1, x2, y2, size, color) {
                ctx.lineJoin = "round";
                ctx.lineCap = "round";
                ctx.strokeStyle = color;
                ctx.lineWidth = size;
                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();
            }

            function onResults(results) {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (!video || !canvas) return;
                const ctx = canvas.getContext("2d");

                // Responsive canvas sizing
                const rect = video.getBoundingClientRect();
                if (canvas.width !== rect.width || canvas.height !== rect.height) {
                    canvas.width = rect.width;
                    canvas.height = rect.height;
                    canvas.style.width = rect.width + 'px';
                    canvas.style.height = rect.height + 'px';
                }

                if (!results || !results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                    drawingRef.current.isDrawing = false;
                    setStatus("ðŸ‘‹ Show your hand");
                    return;
                }

                const landmarks = results.multiHandLandmarks[0];
                const indexTip = landmarks[8];
                const thumbTip = landmarks[4];

                const ix = indexTip.x * canvas.width;
                const iy = indexTip.y * canvas.height;
                const tx = thumbTip.x * canvas.width;
                const ty = thumbTip.y * canvas.height;

                const d = Math.hypot(ix - tx, iy - ty);
                const pinch = d < pinchThreshold;

                setStatus(pinch ? "ðŸŽ¨ Drawing!" : `âœ‹ Pinch to draw (${Math.round(d)})`);

                if (pinch) {
                    if (!drawingRef.current.isDrawing) {
                        drawingRef.current.isDrawing = true;
                        drawingRef.current.lastX = ix;
                        drawingRef.current.lastY = iy;
                    } else {
                        const lx = drawingRef.current.lastX;
                        const ly = drawingRef.current.lastY;
                        drawLine(ctx, lx, ly, ix, iy, brushSize, brushColor);
                        drawingRef.current.lastX = ix;
                        drawingRef.current.lastY = iy;
                    }
                } else {
                    drawingRef.current.isDrawing = false;
                    drawingRef.current.lastX = ix;
                    drawingRef.current.lastY = iy;
                }
            }

            function loadScript(src) {
                return new Promise((resolve, reject) => {
                    const existing = document.querySelector(`script[src="${src}"]`);
                    if (existing) {
                        if (existing.hasAttribute("data-loaded")) return resolve();
                        existing.addEventListener("load", resolve);
                        existing.addEventListener("error", reject);
                        return;
                    }

                    const script = document.createElement("script");
                    script.src = src;
                    script.async = true;
                    script.onload = () => {
                        script.setAttribute("data-loaded", "true");
                        resolve();
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                });
            }

            async function start() {
                if (running) return;
                setStatus("ðŸš€ Starting...");

                try {
                    const video = videoRef.current;
                    if (!video) throw new Error("Video element not found");

                    setStatus("ðŸ“· Requesting camera...");
                    
                    // Mobile-optimized camera constraints
                    const constraints = {
                        video: {
                            width: { ideal: isMobile ? 720 : 1280 },
                            height: { ideal: isMobile ? 480 : 720 },
                            facingMode: 'user',
                            frameRate: { ideal: isMobile ? 15 : 30 }
                        }
                    };
                    
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = stream;
                    
                    await new Promise(resolve => {
                        video.onloadedmetadata = resolve;
                    });

                    setStatus("ðŸ§  Loading AI models...");
                    await loadScript("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js");
                    
                    if (!window.Hands) {
                        throw new Error("MediaPipe failed to load");
                    }

                    const hands = new window.Hands({
                        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`,
                    });

                    hands.setOptions({
                        maxNumHands: 1,
                        minDetectionConfidence: isMobile ? 0.5 : 0.6,
                        minTrackingConfidence: isMobile ? 0.4 : 0.5,
                    });

                    hands.onResults(onResults);
                    handsRef.current = hands;

                    const processFrame = async () => {
                        if (handsRef.current && video.readyState >= 2 && running) {
                            try {
                                await handsRef.current.send({ image: video });
                            } catch (e) {
                                console.error("Frame processing error:", e);
                            }
                        }
                        if (running) {
                            animationRef.current = requestAnimationFrame(processFrame);
                        }
                    };

                    setRunning(true);
                    setStatus("âœ‹ Show your hand!");
                    processFrame();

                } catch (err) {
                    console.error("Start error:", err);
                    setStatus(`âŒ Error: ${err.message}`);
                }
            }

            function stop() {
                if (!running) return;
                setRunning(false);
                
                if (animationRef.current) {
                    cancelAnimationFrame(animationRef.current);
                }

                try {
                    const video = videoRef.current;
                    if (video?.srcObject) {
                        video.srcObject.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                } catch (e) {
                    console.warn("Stop camera error:", e);
                }

                try {
                    if (handsRef.current?.close) {
                        handsRef.current.close();
                    }
                } catch (e) {
                    console.warn("Stop hands error:", e);
                }

                handsRef.current = null;
                setStatus("â¹ï¸ Stopped");
            }

            useEffect(() => {
                return () => stop();
            }, []);

            function clearCanvas() {
                const canvas = canvasRef.current;
                if (canvas) {
                    const ctx = canvas.getContext("2d");
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            }

            function savePNG() {
                const canvas = canvasRef.current;
                if (canvas) {
                    const link = document.createElement("a");
                    link.download = `airdraw-${Date.now()}.png`;
                    link.href = canvas.toDataURL("image/png");
                    link.click();
                }
            }

            return React.createElement('div', {
                className: "min-h-screen bg-gray-100 dark:bg-gray-900"
            }, [
                React.createElement('div', {
                    key: 'header',
                    className: "bg-white dark:bg-gray-800 shadow-sm p-4"
                }, [
                    React.createElement('h1', {
                        key: 'title',
                        className: "text-xl font-bold text-center"
                    }, "âœ‹ AirDraw"),
                    React.createElement('p', {
                        key: 'subtitle',
                        className: "text-sm text-gray-600 dark:text-gray-400 text-center mt-1"
                    }, "Draw in the air with hand gestures")
                ]),

                React.createElement('div', {
                    key: 'main',
                    className: "p-4 space-y-4"
                }, [
                    React.createElement('div', {
                        key: 'video-container',
                        className: "relative bg-black rounded-lg overflow-hidden shadow-lg"
                    }, [
                        React.createElement('video', {
                            key: 'video',
                            ref: videoRef,
                            autoPlay: true,
                            playsInline: true,
                            muted: true,
                            className: "w-full h-auto"
                        }),
                        React.createElement('canvas', {
                            key: 'canvas',
                            ref: canvasRef,
                            className: "absolute top-0 left-0 w-full h-full",
                            style: { touchAction: "none" }
                        })
                    ]),

                    React.createElement('div', {
                        key: 'status',
                        className: "text-center p-3 bg-blue-50 dark:bg-blue-900 rounded-lg"
                    }, React.createElement('p', {
                        className: "text-sm font-medium"
                    }, status)),

                    React.createElement('div', {
                        key: 'controls',
                        className: "bg-white dark:bg-gray-800 p-4 rounded-lg shadow space-y-3"
                    }, [
                        React.createElement('div', {
                            key: 'main-buttons',
                            className: "flex gap-2"
                        }, [
                            React.createElement('button', {
                                key: 'start-stop',
                                onClick: () => (running ? stop() : start()),
                                className: `flex-1 py-3 px-4 rounded-lg font-medium ${running ? "bg-red-500 hover:bg-red-600 text-white" : "bg-green-500 hover:bg-green-600 text-white"}`
                            }, running ? "ðŸ›‘ Stop" : "â–¶ï¸ Start"),

                            React.createElement('button', {
                                key: 'clear',
                                onClick: clearCanvas,
                                className: "py-3 px-4 rounded-lg bg-gray-200 hover:bg-gray-300 dark:bg-gray-600 dark:hover:bg-gray-500"
                            }, "ðŸ—‘ï¸"),

                            React.createElement('button', {
                                key: 'save',
                                onClick: savePNG,
                                className: "py-3 px-4 rounded-lg bg-blue-500 hover:bg-blue-600 text-white"
                            }, "ðŸ’¾")
                        ]),

                        React.createElement('div', {
                            key: 'sliders',
                            className: "space-y-3"
                        }, [
                            React.createElement('div', {
                                key: 'color-control',
                                className: "flex items-center gap-3"
                            }, [
                                React.createElement('label', {
                                    className: "text-sm font-medium w-16"
                                }, "Color"),
                                React.createElement('input', {
                                    type: "color",
                                    value: brushColor,
                                    onChange: (e) => setBrushColor(e.target.value),
                                    className: "w-12 h-10 rounded border"
                                })
                            ]),

                            React.createElement('div', {
                                key: 'size-control',
                                className: "flex items-center gap-3"
                            }, [
                                React.createElement('label', {
                                    className: "text-sm font-medium w-16"
                                }, "Size"),
                                React.createElement('input', {
                                    type: "range",
                                    min: 2,
                                    max: isMobile ? 40 : 50,
                                    value: brushSize,
                                    onChange: (e) => setBrushSize(Number(e.target.value)),
                                    className: "flex-1"
                                }),
                                React.createElement('span', {
                                    className: "text-sm w-8 text-right"
                                }, brushSize)
                            ]),

                            React.createElement('div', {
                                key: 'threshold-control',
                                className: "flex items-center gap-3"
                            }, [
                                React.createElement('label', {
                                    className: "text-sm font-medium w-16"
                                }, "Pinch"),
                                React.createElement('input', {
                                    type: "range",
                                    min: 20,
                                    max: 100,
                                    value: pinchThreshold,
                                    onChange: (e) => setPinchThreshold(Number(e.target.value)),
                                    className: "flex-1"
                                }),
                                React.createElement('span', {
                                    className: "text-sm w-8 text-right"
                                }, pinchThreshold)
                            ])
                        ])
                    ]),

                    React.createElement('div', {
                        key: 'instructions',
                        className: "bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg"
                    }, [
                        React.createElement('h3', {
                            key: 'inst-title',
                            className: "text-sm font-medium mb-2"
                        }, "ðŸ“– How to use:"),
                        React.createElement('ol', {
                            key: 'inst-list',
                            className: "text-sm space-y-1 pl-4"
                        }, [
                            React.createElement('li', { key: '1' }, "1. Click Start and allow camera access"),
                            React.createElement('li', { key: '2' }, "2. Hold your hand in front of camera"),
                            React.createElement('li', { key: '3' }, "3. Pinch thumb and index finger to draw"),
                            React.createElement('li', { key: '4' }, "4. Move your hand while pinching"),
                            React.createElement('li', { key: '5' }, "5. Release to stop drawing")
                        ])
                    ])
                ])
            ]);
        }

        ReactDOM.render(React.createElement(AirDraw), document.getElementById('root'));
    </script>
</body>
</html>